mistplayers.rawws={name:"WebCodec Player",mimes:["ws/video/raw"],priority:MistUtil.object.keys(mistplayers).length+1,isMimeSupported:function(e){return MistUtil.array.indexOf(this.mimes,e)==-1?false:true},isBrowserSupported:function(e,t,r){if(!("WebSocket"in window)||r.info.capa&&!r.info.capa.ssl){r.log("This player requires websocket support");return false}if(!window.VideoDecoder||!window.AudioDecoder){return false}if(!window.Worker)return false;if(location.protocol!=MistUtil.http.url.split(t.url.replace(/^ws/,"http")).protocol){if(location.protocol=="file:"&&MistUtil.http.url.split(t.url.replace(/^ws/,"http")).protocol=="http:"){r.log("This page was loaded over file://, the player might not behave as intended.")}else{r.log("HTTP/HTTPS mismatch for this source");return false}}var i={};if(this.cacheSupported&&r.stream in this.cacheSupported){i=this.cacheSupported[r.stream]}else{this.cacheSupported[r.stream]={}}if(r.info&&r.info.meta&&r.info.meta.tracks){var n={};for(var a in r.info.meta.tracks){var o=r.info.meta.tracks[a];switch(o.type){case"audio":case"video":{if(a in i){if(i[a])n[o.type]=true}else{n[o.type]="maybe"}break}case"meta":{if(o.codec=="subtitle")n.subtitle=true;break}}}this.cacheSupported[r.stream].last=n;return Object.keys(n)}return[]},player:function(){this.onreadylist=[]},cacheSupported:{},isTrackSupported:function(e){function t(e){var t=new Uint8Array(e.length);for(i=0;i<e.length;i++){t[i]=e.charCodeAt(i)}return t}var r;var n={codec:e.codecstring?e.codecstring:(""+e.codec).toLowerCase()};if(e.init!=""){n.description=t(e.init)}switch(e.type){case"video":{if(e.codec=="JPEG"){if(!window.ImageDecoder){return new Promise(function(e,t){e({supported:false,config:{codec:"image/jpeg"}})})}r=ImageDecoder;r.isConfigSupported=function(){return new Promise(function(e,t){r.isTypeSupported("image/jpeg").then(function(t){e({supported:t,config:{codec:"image/jpeg"}})}).catch(t)})}}else r=VideoDecoder;break}case"audio":{r=AudioDecoder;n.numberOfChannels=e.channels;n.sampleRate=e.rate;break}default:{return false}}return new Promise(function(e,t){r.isConfigSupported(n).then(function(t){e(t)}).catch(t)})}};var p=mistplayers.rawws.player;p.prototype=new MistPlayer;p.prototype.build=function(e,t){var r=this;var i=document.createElement("video");this.setSize=function(e){i.style.width=e.width+"px";i.style.height=e.height+"px"};var n;n=true;Object.defineProperty(this,"debugging",{get:function(){return n},set:function(e){if(e!==n){n=e;if(this.controller&&this.controller.worker){this.controller.worker.post({type:"debugging",value:e})}}return n}});this.debugging=n;if(!window.MediaStreamTrackGenerator){var a=class e{constructor({kind:e}){if(e=="video"){const t=document.createElement("canvas");const r=t.getContext("2d",{desynchronized:true});const i=t.captureStream().getVideoTracks()[0];i.writable=new WritableStream({write(e){t.width=e.displayWidth;t.height=e.displayHeight;r.drawImage(e,0,0,t.width,t.height);e.close()}});return i}else if(e=="audio"){const n=new AudioContext({latencyHint:"interactive"});const a=n.createMediaStreamDestination();const[o]=a.stream.getAudioTracks();const s=this;function c(e){const t=new Float32Array(e.numberOfFrames*e.numberOfChannels);const r=new Float32Array(e.numberOfFrames);e.copyTo(t,{planeIndex:0});for(var i in r){r[i]=t[i*e.numberOfChannels]}return r}function l(e){const t=new Float32Array(e.numberOfFrames*e.numberOfChannels);e.copyTo(t,{planeIndex:0});return t}o.writable=new WritableStream({async start(e){this.arrays=[];function t(){registerProcessor("mstg-shim",class e extends AudioWorkletProcessor{constructor(){super();this.arrays=[];this.arrayOffset=0;this.port.onmessage=({data:e})=>this.arrays.push(e);this.emptyArray=new Float32Array(0)}process(e,[[t]]){for(let e=0;e<t.length;e++){if(!this.array||this.arrayOffset>=this.array.length){this.array=this.arrays.shift()||this.emptyArray;this.arrayOffset=0}t[e]=this.array[this.arrayOffset++]||0}return true}})}await n.audioWorklet.addModule(`data:text/javascript,(${t.toString()})()`);this.node=new AudioWorkletNode(n,"mstg-shim");this.node.connect(a);return o},write(e){const t=c(e);(e=>{this.node.port.postMessage(e,[e.buffer])})(t);e.close()}});return o}}}}var o=[];function s(t){var n=this;this.connecting=false;this.createControlChannel=function(){this.control=new MistUtil.shared.ControlChannel(function(){var e=new WebSocket(t);e.binaryType="arraybuffer";return e},e);this.connection=this.control;this.control.addListener("channel_timeout").then(function(){e.log("Control channel timeout - try next combo","error");e.nextCombo(undefined,"control channel timeout")});this.control.addListener("channel_error").then(function(){if(n.control.was_connected){e.log("Attempting to reconnect control channel");n.createControlChannel()}});Object.defineProperty(this.control,"debugging",{get:function(){return r.debugging}});var a=this.control;var o=false;this.control.addListener("on_time",function(t){for(var i in t.tracks){var s=t.tracks[i];if(!(s in n.pipelines)){if(r.debugging)console.warn("‚ñ∂Ô∏è","Received on_time with track "+s+" but there is no pipeline for it, attempting to create it");var c=new d(s)}}for(var s in n.pipelines){if(t.tracks.indexOf(Number(s))<0){n.pipelines[s].close(true)}}var l=n.frameTiming.server;if(l&&t.current!=l.current){for(var s in n.pipelines){var f=n.pipelines[s];if(f.waitingTimer){clearTimeout(f.waitingTimer);f.waitingTimer=false}}}var u={low:.6,high:2};var p={faster:1.05,slower:.98};var m=null;var g=n.frameTiming.out;var y=n.frameTiming.in;var w=n.frameTiming.decoded;if(g&&w){m=Math.round(w*.001-g*.001);decodingTime=Math.round(y*.001-w*.001)}if(m!==null&&!n.frameTiming.seeking&&!o){var v=n.desiredBuffer();if(r.debugging){var k=["‚ñ∂Ô∏è","Buffer:",function(){if(m>v*u.high){return"‚¨ÜÔ∏è"}if(m<v*u.low){return"‚¨áÔ∏è"}return"üü¢"}(),m,"/",v,{keepAway:h,serverDelay:Math.round(n.control.serverDelay.get()),jitter:Math.round(n.jitter.get())},"Available:",t.end-t.current,"Tweak:",function(e){if(e>1){return"‚ÜóÔ∏è"}if(e<1){return"‚ÜòÔ∏è"}return"üü¢"}(n.frameTiming.speed.tweak),n.frameTiming.speed.tweak];if(e.info.type=="live"){k.unshift("From live:",Math.round(t.end*.01-g*1e-5)/10,"s")}console.log.apply(null,k)}if(m<v*u.low&&t.play_rate_curr!="fast-forward"&&n.frameTiming.speed.tweak>=1){var b=0;if(m<10){var _=r.api.earliness;if(_)b=-1*Math.min.apply(null,Object.values(_));b=Math.max(0,b)}if(t.current<t.end){o=true;a.send({type:"fast_forward",ff_add:v+b});if(n.frameTiming.speed.tweak>1){n.frameTiming.tweakSpeed(1)}e.log("Our buffer ("+m+"ms) is small (<"+Math.round(v*u.low)+"ms), requesting more data (+"+Math.round(v+b)+"ms)..");var T=false;a.addListener("set_speed").then(function(i){T=true;if(i.play_rate_prev=="fast-forward"){a.addListener("on_time").then(function(i){var a=0;var s=n.frameTiming.out;var c=n.frameTiming.in;if(s&&c){a=Math.round(c*.001-s*.001)}var l=i.current-t.current-(i._received-t._received);if(r.debugging)console.warn("‚ñ∂Ô∏è","Extra buffer received:",i.current-t.current,"ms","Time taken:",i._received-t._received,"ms","Increase:",l,"ms");if(m+l<v*u.low){n.frameTiming.tweakSpeed(p.slower);h+=100;e.log("Didn't receive enough extra data to increase our buffer ("+l+"/"+Math.round(v*u.low-m)+"ms): slowing down..")}else{e.log("Received +"+l+"ms extra data")}o=false})}else{o=false}});a.addListener("on_time").then(function(t){if(T)return;if(o&&t.play_rate_curr!="fast-forward"){o=false;n.frameTiming.tweakSpeed(p.slower);h+=100;e.log("Didn't receive extra data: slowing down..")}})}else{if(n.frameTiming.speed.main>1){a.send({type:"set_speed",play_rate:"auto"})}n.frameTiming.tweakSpeed(p.slower);e.log("Our buffer ("+m+"ms) is small (<"+Math.round(v*u.low)+"ms), but can't request more data: slowing down..")}}else{if(n.frameTiming.speed.tweak<1&&m>=v){n.frameTiming.tweakSpeed(1);e.log("Our buffer ("+m+"ms) is large enough (>"+Math.round(v)+"ms), so return to normal playback.")}else{if(e.info.type=="live"&&e.options.liveCatchup){if(t.play_rate_curr=="auto"&&n.frameTiming){var S=0;for(var i in n.pipelines){S=Math.max(S,n.pipelines[i].stats.frame_duration)}v=Math.max(v,S*.001);if(n.frameTiming.speed.tweak<=1&&m>v*u.high){n.frameTiming.tweakSpeed(p.faster);e.log("Our buffer ("+m+"ms) is big (>"+Math.round(v*u.high)+"ms), so tweak the playback speed to catch up.")}else if(n.frameTiming.speed.tweak>1&&m<=v){n.frameTiming.tweakSpeed(1);e.log("Our buffer ("+m+"ms) is small enough (<"+Math.round(v)+"ms), so return to normal playback.")}}if(t.play_rate_curr!="fast-forward"){var x=t.end-t.current;if(x<e.options.liveCatchup*1e3&&x>Math.max(t.jitter*1.1,t.jitter+250)&&m-v<1e3){a.send({type:"fast_forward",ff_add:5e3});e.log("We're away ("+x+"ms) from the live point, requesting more data..")}}}}}}n.frameTiming.server=t});this.control.addListener("set_speed",function(e){var t;switch(e.play_rate_curr){case"auto":case"fast-forward":{t=1;break}default:{t=e.play_rate_curr;break}}n.frameTiming.setSpeed(t);n.jitter.setSpeed(e.play_rate_curr)});this.control.addSendListener("seek",function(e){var t=e.seek_time;n.worker.post({type:"seek",seek_time:t});MistUtil.event.send("seeking",t*.001,i);n.jitter.reset();if(r.debugging)console.warn("‚ñ∂Ô∏è","Seeking to ["+MistUtil.format.time(t*.001)+"]: Emptying decoding and display queues")});this.control.addListener("pause",function(e){if(e.paused)n.frameTiming.paused=true});this.control.addSendListener("play",function(){n.frameTiming.reset()});return this.control};this.control=this.createControlChannel();function o(e){var t,r;this.get=function(){var i=e();var n=performance.now();var a;if(typeof t!="undefined"){var o=i-t;var s=n-r;s*=.001;a=o/s}t=i;r=n;return a}}function s(){var e={};this.complete=[];this.last_in=undefined;this.last_out=undefined;this.shift_array=[];this.start=function(t){this.last_in=t;e[t]=performance.now()};this.end=function(t){this.last_out=t;var r=0;if(!(t in e)){t=function(e){for(var t in e)return t;return undefined}(e);if(t===undefined)return;r=t-this.last_out}this.complete.push(performance.now()-e[t]);this.shift_array.push(r);delete e[t];while(this.complete.length>16){this.complete.shift()}while(this.shift_array.length>8){this.shift_array.shift()}};this.getCopy=function(){return{complete:this.complete,last_in:this.last_in,last_out:this.last_out,shift_array:this.shift_array}};Object.defineProperty(this,"delay",{get:function(){if(this.complete.length){return this.complete.reduce(function(e,t){return e+t})/this.complete.length}return undefined}});Object.defineProperty(this,"delta",{get:function(){if(this.last_out!==undefined)return this.last_in-this.last_out;return undefined}});Object.defineProperty(this,"shift",{get:function(){if(this.shift_array.length){return this.shift_array.reduce(function(e,t){return e+t})/this.shift_array.length}return undefined}})}function c(e){var t=12;var i=new Uint8Array(e.slice(0,t));this.data=new Uint8Array(e.slice(t,e.byteLength));this.track=i[0];this.type=function(e){switch(e){case 1:return"key";case 2:return"init";default:return"delta"}}(i[1]);this.timestamp=function(e){var t=new DataView(e.slice(2,10).buffer);return Number(t.getBigUint64())}(i);this.offset=function(e){return new DataView(e.slice(10,12).buffer).getInt16()}(i);if(r.debugging=="verbose")console.log("‚ñ∂Ô∏è","Parsed binary data received from WS:",MistUtil.format.time((this.timestamp+this.offset)*.001,{ms:true}),this)}function l(t){if(!e.info||!e.info.meta||!e.info.meta.tracks)return;for(var r in e.info.meta.tracks){var i=e.info.meta.tracks[r];if(i.idx==t){return i}}throw"Missing metadata for track "+t}this.data_queue=[];function f(){let e=[];let t=1;let r=0;let i=0;let n=[];let a=120;this.addChunk=function(t){e.push([performance.now(),t.timestamp]);if(e.length>8)e.shift();let o=this.calcJitter();if(o>i)i=o;if(performance.now()>r+1e3){n.push(i);if(n.length>8)n.shift();let e=Math.max.apply(null,n);let t=n.reduce(function(e,t){return e+t})/n.length;let o=(t+e*2)/3+1;if(a>o+500){o=a-500}a=(a+o)/2;i=0;r=performance.now()}};this.calcJitter=function(){if(e.length<=1)return 0;if(t=="fast_forward")return 0;let r=e[0];let i=e[e.length-1];let n=i[0]-r[0];let a=i[1]-r[1];let o=a/t-n;return Math.max(0,o)};this.get=function(){return a};this.setSpeed=function(e){if(t!=e){if(e=="auto")e=1;t=e;this.reset()}};this.reset=function(){e=[]}}this.jitter=new f;this.receiver=function(t){var a=new c(t);if(!(a.track in n.pipelines)){if(r.debugging)console.warn("‚ñ∂Ô∏è","Received data for track "+a.track+" but there is no pipeline for it, attempting to create it");new d(a.track)}var o=n.pipelines[a.track];if(a.type=="init"){o.configure(a.data);return}try{o.receive({type:a.type,timestamp:(a.timestamp+a.offset)*1e3,data:a.data});MistUtil.event.send("progress",null,i)}catch(t){if(r.debugging)console.error("‚ñ∂Ô∏è","Error while decoding track "+a.track+" ("+o.track.codec+" "+o.track.type+")",a,t);e.log(t+" while decoding track "+a.track+" ("+o.track.codec+" "+o.track.type+")");o.reset()}n.jitter.addChunk(a)};this.pipelines={};Object.defineProperty(this.pipelines,"audio",{enumerable:false,get:function(){for(var e in this){if(this[e].track&&this[e].track.type=="audio"){return this[e]}}}});Object.defineProperty(this.pipelines,"video",{enumerable:false,get:function(){for(var e in this){if(this[e].track&&this[e].track.type=="video"){return this[e]}}}});function u(){var e=this;this.worker=new Worker("../players/webcodecsworker.js");this.worker.onmessage=function(t){var i=t.data;var a=[i.type,i.idx,i.uid].join("_");if(i.stats){if(i.stats.FrameTiming){Object.assign(n.frameTiming,i.stats.FrameTiming)}if(i.stats.pipelines){for(var o in i.stats.pipelines){if(o in n.pipelines){var s=n.pipelines[o];var c=i.stats.pipelines[o];s.stats.early=c.early;s.stats.frame_duration=c.frame_duration;Object.assign(s.stats.frames,c.frames);Object.assign(s.stats.queues,c.queues);Object.assign(s.stats.timing.decoder,c.timing.decoder);Object.assign(s.stats.timing.writable,c.timing.writable)}}}}var l=false;if(a in e.listeners){e.listeners[a](i);if(i.uid)delete e.listeners[a];l=true}a=[i.type,i.idx,""].join("_");if(a in e.listeners){e.listeners[a](i);l=true}a=[i.type,"",""].join("_");if(a in e.listeners){e.listeners[a](i);l=true}if(r.debugging){switch(i.type){case"receive":case"writeframe":case"log":{break}case"sendevent":{if(i.kind=="timeupdate")break}default:{console.log("üíº","Worker sent:",i)}}}if(!l)console.warn("‚ñ∂Ô∏è","Received unhandled msg from worker",i)};this.listeners={};var t=0;this.addListener=function(e,t){var r=[e.type,e.idx,e.uid].join("_");if(t){this.listeners[r]=t}else{var i=this;return new Promise(function(e,t){i.listeners[r]=function(r){if(r.status=="error")return t(r);e(r)}})}};this.post=function(r,i){if(!("uid"in r)){r.uid=t++}if(i&&i.transfer&&!Array.isArray(i.transfer)){i.transfer=[i.transfer]}this.worker.postMessage(r,i);return new Promise(function(t,i){e.addListener(r).then(t).catch(i)})};this.terminate=function(){this.worker.terminate()};e.post({type:"debugging",value:r.debugging})}this.worker=new u;this.worker.addListener({type:"writeframe"},function(e){var t=n.pipelines[e.idx];if(t){var r=e.frame.timestamp;t.trackWriter.write(e.frame).then(function(){n.worker.post({type:"writeframe",idx:e.idx,uid:r,status:"ok"})}).catch(function(t){n.worker.post({type:"writeframe",idx:e.idx,uid:r,status:"error",error:t})})}else{n.worker.post({type:"writeframe",idx:e.idx,uid:e.frame.timestamp,status:"error",error:"Pipeline not active"})}});this.worker.addListener({type:"log"},function(t){e.log("WebCodecsWorker: "+t.msg)});this.worker.addListener({type:"sendevent"},function(e){MistUtil.event.send(e.kind,e.message?e.message:"idx"in e?"track "+e.idx:null,i)});this.worker.addListener({type:"addtrack"},function(e){var t=n.pipelines[e.idx];if(t){if("track"in e){t.trackGenerator=e.track}else{if(!t.trackGenerator){t.createTrackGenerator()}}if(t.trackGenerator)n.stream.addTrack(t.trackGenerator)}});this.worker.addListener({type:"removetrack"},function(e){var t=n.pipelines[e.idx];if(t){n.stream.removeTrack(t.trackGenerator);t.trackGenerator=null}});this.worker.addListener({type:"setplaybackrate"},function(t){e.video.playbackRate=t.speed});this.worker.addListener({type:"closed"},function(e){if(e.idx in n.pipelines){delete n.pipelines[e.idx]}});function d(t){if(!(typeof t=="object")){t=l(t)}if(t.type!="audio"&&t.type!="video"){n.control.send({type:"hold"});return}function r(e,r){e.idx=t.idx;if(r)return n.worker.post(e,{transfer:r});return n.worker.post(e)}var i=this;i.track=t;i.stats={early:null,frames:{in:0,decoded:0,out:0},framerate:{in:new o(function(){return i.stats.frames.in}),decoded:new o(function(){return i.stats.frames.decoded}),out:new o(function(){return i.stats.frames.out})},queues:{in:0,decoder:0,out:0},timing:{decoder:new s,writable:new s}};i.createTrackGenerator=function(){if(!window.MediaStreamTrackGenerator){if(t.type=="video"){r({type:"creategenerator"})}else if(t.type=="audio"){i.trackGenerator=new a({kind:"audio"});i.trackWriter=i.trackGenerator.writable.getWriter();r({type:"creategenerator"})}}else{i.trackGenerator=a?new a({kind:t.type}):new window.MediaStreamTrackGenerator({kind:t.type});r({type:"setwritable",writable:i.trackGenerator.writable},i.trackGenerator.writable)}};i.configure=function(e){r({type:"configure",header:e},"buffer"in e?e.buffer:undefined)};i.receive=function(e){r({type:"receive",chunk:e},e.data.buffer)};i.close=function(e){r({type:"close",waitEmpty:e})};e.log("Creating pipeline for track "+t.idx+" ("+t.codec+" "+t.type+")");r({type:"create",track:t,opts:{optimizeForLatency:e.info.type=="live"}});i.createTrackGenerator();n.pipelines[t.idx]=i}function p(){this.tweakSpeed=function(e){this.setSpeed(this.speed.main,e)};this.setSpeed=function(e,t){n.worker.post({type:"frametiming",action:"setSpeed",speed:e,tweak:t})};this.reset=function(){n.worker.post({type:"frametiming",action:"reset"});this.in=null;this.decoded=null;this.out=null;this.paused=false;this.speed={main:1,tweak:1,combined:1}};this.reset()}this.frameTiming=new p;var h=e.info.type=="live"?100:500;this.desiredBuffer=function(){var e=h+n.control.serverDelay.get()+n.jitter.get();return Math.round(e)};this.connect=function(){if(this.connecting){return this.connecting}this.connecting=new Promise(function(t,a){var o=n.control;if(o.connectionState=="closing"||o.connectionState=="closed"){o.reconnect()}n.stream=new MediaStream;i.srcObject=n.stream;n.frameTiming.reset();return n.control.addListener("channel_open").then(function(){var t=[Object.values(m).filter(function(e){return e.length})];o.send({type:"request_codec_data",supported_combinations:t});e.log("Requesting codecs: "+t.join(", "));n.connecting=false;return o.addListener("codec_data")}).then(function(r){if(!r.codecs||!r.codecs.length){throw"No playable codecs available"}for(var a in r.tracks){var s=r.tracks[a];if(!(a in r.codecs))throw"No codec data for track "+s;n.pipelines[s]=new d(s)}o.send({type:"play"});o.addListener("binary",n.receiver);if(!e.options.autoplay){try{i.play()}catch(e){}setTimeout(function(){o.send({type:"hold"})},100)}t()}).catch(function(t){e.showError(t);if(r.debugging){console.error("‚ñ∂Ô∏è",t)}})});return this.connecting};this.close=function(){this.control.removeListener("binary",n.receiver);this.control.close();if(n.stream){for(var e in n.pipelines){n.pipelines[e].close()}}};var m={audio:[],video:[]};function g(){var t=[],r=mistplayers.rawws;if(!(e.stream in r.cacheSupported)){r.cacheSupported[e.stream]={}}var i=r.cacheSupported[e.stream];function n(r){function n(e,t){if(e.indexOf(t)<0)e.push(t)}var a=e.info.meta.tracks[r];if(a.type!="audio"&&a.type!="video"){return}if(r in i){if(i[r]){n(m[a.type],a.codec)}}else{t.push(mistplayers.rawws.isTrackSupported(a).then(function(e){i[r]=e.supported;if(e.supported){n(m[a.type],a.codec)}}))}}for(var a in e.info.meta.tracks){n(a)}if(t.length){Promise.all(t).then(y).catch(console.err)}else{y()}}function y(){var t=false;if(t){m={audio:[],video:[]};for(var r in e.info.meta.tracks){var i=e.info.meta.tracks[r];switch(i.type){case"audio":case"video":{if(m[i.type].indexOf(i.codec)<0)m[i.type].push(i.codec)}}}}else{var a=mistplayers.rawws.cacheSupported[e.stream].last;var o=e.scoreCombo(mistplayers.rawws.isBrowserSupported(e.source.type,e.source,e));if(o<1){e.log("After testing decoders, "+mistplayers[e.playerName].name+" cannot play any tracks after all: trying next combo..");e.nextCombo(false,"rawws cannot play any tracks");return}var s=mistplayers.rawws.cacheSupported[e.stream].last;for(var c in a){if(!(c in s)){var l=e.checkCombo({startCombo:false},true);if(l.score>o&&l.player!=e.playerName){e.log("After testing decoders, "+mistplayers[e.playerName].name+" is no longer the best scoring player, trying next combo..");e.nextCombo(false,"after testing, rawws is no longer the best player");return}break}}e.log("Confirmed "+mistplayers[e.playerName].name+" is still the best scoring player, connecting..")}n.connect()}g()}this.controller=new s(e.source.url);var c={};c.currentTime={get:function(){var e=r.controller.frameTiming;if(e){var t=e.out;return t?t*1e-6:0}else return 0},set:function(e){r.controller.control.send({type:"seek",seek_time:e=="live"?"live":Math.round(e*1e3),ff_add:r.controller.desiredBuffer()})}};c.buffered={get:function(){return new function e(){var t=r.controller.frameTiming;Object.defineProperty(this,"length",{get:function(){if(t&&t.in&&t.out)return 2;return 0}});this.start=function(e){if(t){var r;switch(e){case 0:r=t.out;break;case 1:r=t.decoded;break;default:throw new Error("Index out of bounds")}return r?r*1e-6:0}};this.end=function(e){if(t){var r;switch(e){case 0:r=t.decoded;break;case 1:r=t.in;break;default:throw new Error("Index out of bounds")}return r?r*1e-6:0}}}}};c.duration={get:function(){var t=r.controller.frameTiming;if(t){var i=t.server;if(i&&"end"in i){if(e.info&&e.info.type=="live"){return(i.end+(new Date).getTime()-i._received.getTime())*.001}else return i.end*.001}}return 0}};c.stream_end=function(){var e=[];for(var t in r.controller.pipelines){e.push(r.controller.pipelines[t].close(true))}Promise.all(e).then(function(){MistUtil.event.send("ended",null,i)})};var l=false;c.restart=function(){if(l)return;l=true;var t=[];for(var i in r.controller.pipelines){t.push(r.controller.pipelines[i].close(true))}Promise.all(t).then(function(){e.log("Looping..");var t=r.controller.close();if(t instanceof Promise){t.then(function(){r.controller.connect().then(function(){l=false})})}else{r.controller.connect().then(function(){l=false})}})};c.receiveQueue={get:function(){var e={};for(var t in r.controller.pipelines){var i=r.controller.pipelines[t];if(i.track){e[i.track.type]=i.stats.queues.in}}return e}};c.decodeQueue={get:function(){var e={};for(var t in r.controller.pipelines){var i=r.controller.pipelines[t];if(i.track){e[i.track.type]=i.stats.queues.decoder}}return e}};c.displayQueue={get:function(){var e={};for(var t in r.controller.pipelines){var i=r.controller.pipelines[t];if(i.track){e[i.track.type]=i.stats.queues.out}}return e}};c.displayBuffer={get:function(){var e={};for(var t in r.controller.pipelines){var i=r.controller.pipelines[t];if(i.track){e[i.track.type]=(i.stats.timing.decoder.last_out-i.stats.timing.writable.last_in)*.001}else{e[i.track.type]=0}}return e}};c.earliness={get:function(){var e={};for(var t in r.controller.pipelines){var i=r.controller.pipelines[t];if(i.track){if("early"in i.stats){e[i.track.type]=i.stats.early}else{e[i.track.type]=0}}}return e}};c.sync={get:function(){var e;var t;for(var i in r.controller.pipelines){var n=r.controller.pipelines[i];if(n.track){if(n.closeWhenEmpty)continue;switch(n.track.type){case"audio":{e=n;break}case"video":{t=n;break}}}}function a(e){return e.stats.timing.writable.last_out}try{return Math.abs(a(e)-a(t))*.001}catch{return 0}}};c.framerate_in={get:function(){return function(){var e={};for(var t in r.controller.pipelines){var i=r.controller.pipelines[t];if(i.track){if("in"in i.stats.framerate){e[i.track.type]=i.stats.framerate.in.get()}else{e[i.track.type]=0}}}return e}}};c.framerate_decoder={get:function(){return function(){var e={};for(var t in r.controller.pipelines){var i=r.controller.pipelines[t];if(i.track){if("decoded"in i.stats.framerate){e[i.track.type]=i.stats.framerate.decoded.get()}else{e[i.track.type]=0}}}return e}}};c.framerate_out={get:function(){return function(){var e={};for(var t in r.controller.pipelines){var i=r.controller.pipelines[t];if(i.track){if("out"in i.stats.framerate){e[i.track.type]=i.stats.framerate.out.get()}else{e[i.track.type]=0}}}return e}}};c.local_jitter={get:function(){return r.controller.jitter.get()}};c.decodeTime={get:function(){var e={};for(var t in r.controller.pipelines){var i=r.controller.pipelines[t];if(i.track){if(i.stats.timing.decoder){e[i.track.type]=i.stats.timing.decoder.delay}else{e[i.track.type]=0}}}return e}};c.displayTime={get:function(){var e={};for(var t in r.controller.pipelines){var i=r.controller.pipelines[t];if(i.track){if(i.stats.timing.writable){e[i.track.type]=i.stats.timing.writable.delay}else{e[i.track.type]=0}}}return e}};c.shift={get:function(){var e={};for(var t in r.controller.pipelines){var i=r.controller.pipelines[t];if(i.track){if(i.stats.timing.decoder){e[i.track.type]=i.stats.timing.decoder.shift}else{e[i.track.type]=0}}}return e}};this.api=new MistUtil.shared.ControlChannelAPI(r.controller,e,i,c);this.api.unload=function(){r.controller.worker.terminate();r.controller.close()};t(i)};