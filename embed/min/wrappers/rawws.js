mistplayers.rawws={name:"WebCodec Player",mimes:["ws/video/raw"],priority:MistUtil.object.keys(mistplayers).length+1,isMimeSupported:function(e){return MistUtil.array.indexOf(this.mimes,e)==-1?false:true},isBrowserSupported:function(e,t,r){if(!("WebSocket"in window)||r.info.capa&&!r.info.capa.ssl){r.log("This player requires websocket support");return false}if(!window.VideoDecoder||!window.AudioDecoder){return false}if(!window.Worker)return false;if(location.protocol!=MistUtil.http.url.split(t.url.replace(/^ws/,"http")).protocol){if(location.protocol=="file:"&&MistUtil.http.url.split(t.url.replace(/^ws/,"http")).protocol=="http:"){r.log("This page was loaded over file://, the player might not behave as intended.")}else{r.log("HTTP/HTTPS mismatch for this source");return false}}var i={};if(this.cacheSupported&&r.stream in this.cacheSupported){i=this.cacheSupported[r.stream]}else{this.cacheSupported[r.stream]={}}if(r.info&&r.info.meta&&r.info.meta.tracks){var n={};for(var a in r.info.meta.tracks){var s=r.info.meta.tracks[a];switch(s.type){case"audio":case"video":{if(a in i){if(i[a])n[s.type]=true}else{n[s.type]="maybe"}break}case"meta":{if(s.codec=="subtitle")n.subtitle=true;break}}}this.cacheSupported[r.stream].last=n;return Object.keys(n)}return[]},player:function(){this.onreadylist=[]},cacheSupported:{},isTrackSupported:function(e){function t(e){var t=new Uint8Array(e.length);for(i=0;i<e.length;i++){t[i]=e.charCodeAt(i)}return t}var r;var n={codec:e.codecstring?e.codecstring:(""+e.codec).toLowerCase()};if(e.init!=""){n.description=t(e.init)}switch(e.type){case"video":{if(e.codec=="JPEG"){r=ImageDecoder;r.isConfigSupported=function(){return new Promise((function(e,t){r.isTypeSupported("image/jpeg").then((function(t){e({supported:t,config:{codec:"image/jpeg"}})})).catch(t)}))}}else r=VideoDecoder;break}case"audio":{r=AudioDecoder;n.numberOfChannels=e.channels;n.sampleRate=e.rate;break}default:{return false}}return new Promise((function(e,t){r.isConfigSupported(n).then((function(t){e(t)})).catch(t)}))}};var p=mistplayers.rawws.player;p.prototype=new MistPlayer;p.prototype.build=function(e,t){var r=this;var i=document.createElement("video");this.setSize=function(e){i.style.width=e.width+"px";i.style.height=e.height+"px"};this.debugging=true;function n(){const e=new AudioContext;const t=e.createMediaStreamDestination();const[r]=t.stream.getAudioTracks();r.writable=new WritableStream({async start(i){this.arrays=[];function n(){registerProcessor("mstg-shim",class e extends AudioWorkletProcessor{constructor(){super();this.arrays=[];this.arrayOffset=0;this.port.onmessage=({data:e})=>this.arrays.push(e);this.emptyArray=new Float32Array(0)}process(e,[[t]]){for(let e=0;e<t.length;e++){if(!this.array||this.arrayOffset>=this.array.length){this.array=this.arrays.shift()||this.emptyArray;this.arrayOffset=0}t[e]=this.array[this.arrayOffset++]||0}return true}})}await e.audioWorklet.addModule(`data:text/javascript,(${n.toString()})()`);this.node=new AudioWorkletNode(e,"mstg-shim");this.node.connect(t);return r},write(e){const t=new Float32Array(e.numberOfFrames*e.numberOfChannels);e.copyTo(t,{planeIndex:0});this.node.port.postMessage(t,[t.buffer]);e.close()}});return r}if(!window.MediaStreamTrackGenerator){window.MediaStreamTrackGenerator=class e{constructor({kind:e}){if(e=="video"){const e=document.createElement("canvas");const t=e.getContext("2d",{desynchronized:true});const r=e.captureStream().getVideoTracks()[0];r.writable=new WritableStream({write(r){e.width=r.displayWidth;e.height=r.displayHeight;t.drawImage(r,0,0,e.width,e.height);r.close()}});return r}else if(e=="audio"){const e=new AudioContext;const t=e.createMediaStreamDestination();const[r]=t.stream.getAudioTracks();r.writable=new WritableStream({start(i){var n=this;this.arrays=[];function a(){registerProcessor("mstg-shim",class e extends AudioWorkletProcessor{constructor(){super();this.arrays=[];this.arrayOffset=0;this.port.onmessage=({data:e})=>this.arrays.push(e);this.emptyArray=new Float32Array(0)}process(e,[[t]]){for(let e=0;e<t.length;e++){if(!this.array||this.arrayOffset>=this.array.length){this.array=this.arrays.shift()||this.emptyArray;this.arrayOffset=0}t[e]=this.array[this.arrayOffset++]||0}return true}})}return e.audioWorklet.addModule(`data:text/javascript,(${a.toString()})()`).then((function(){n.node=new AudioWorkletNode(e,"mstg-shim");n.node.connect(t);return r}))},write(e){const t=new Float32Array(e.numberOfFrames*e.numberOfChannels);e.copyTo(t,{planeIndex:0});this.node.port.postMessage(t,[t.buffer]);e.close()}});return r}}}}var a=[];function s(t){var n=this;this.connecting=false;this.createControlChannel=function(){this.control=new MistUtil.shared.ControlChannel((function(){var e=new WebSocket(t);e.binaryType="arraybuffer";return e}),e);this.connection=this.control;this.control.addListener("channel_timeout").then((function(){e.log("Control channel timeout - try next combo","error");e.nextCombo(undefined,"control channel timeout")}));this.control.addListener("channel_error").then((function(){if(n.control.was_connected){e.log("Attempting to reconnect control channel");n.createControlChannel()}}));Object.defineProperty(this.control,"debugging",{get:function(){return r.debugging}});return this.control};this.control=this.createControlChannel();function a(e){var t=12;var i=new Uint8Array(e.slice(0,t));this.data=new Uint8Array(e.slice(t,e.byteLength));this.track=i[0];this.type=function(e){switch(e){case 1:return"key";case 2:return"init";default:return"delta"}}(i[1]);this.timestamp=function(e){var t=new DataView(e.slice(2,10).buffer);return Number(t.getBigUint64())}(i);this.offset=function(e){return new DataView(e.slice(10,12).buffer).getInt16()}(i);if(r.debugging=="verbose")console.log("Parsed binary data received from WS:",MistUtil.format.time((this.timestamp+this.offset)*.001,{ms:true}),this)}function s(t){if(!e.info||!e.info.meta||!e.info.meta.tracks)return;for(var r in e.info.meta.tracks){var i=e.info.meta.tracks[r];if(i.idx==t){return i}}throw"Missing metadata for track "+t}this.data_queue=[];function o(){let e=[];let t=1;let r=0;let i=0;let n=[];let a=120;this.addChunk=function(t){e.push([performance.now(),t.timestamp]);if(e.length>8)e.shift();let s=this.calcJitter();if(s>i)i=s;if(performance.now()>r+1e3){n.push(i);if(n.length>8)n.shift();let e=Math.max.apply(null,n);let t=n.reduce((function(e,t){return e+t}))/n.length;let s=(t+e*2)/3+1;if(a>s+500){s=a-500}a=(a+s)/2;i=0;r=performance.now()}};this.calcJitter=function(){if(e.length<=1)return 0;if(t=="fast_forward")return 0;let r=e[0];let i=e[e.length-1];let n=i[0]-r[0];let a=i[1]-r[1];let s=a/t-n;return Math.max(0,s)};this.get=function(){return a};this.setSpeed=function(e){if(t!=e){if(e=="auto")e=1;t=e;this.reset()}};this.reset=function(){e=[]}}this.jitter=new o;this.receiver=function(t){var s=new a(t);if(!(s.track in n.pipelines)){if(r.debugging)console.warn("Received data for track "+s.track+" but there is no pipeline for it, attempting to create it");new u(s.track)}var o=n.pipelines[s.track];if(s.type=="init"){o.configure(s.data);return}try{o.receive({type:s.type,timestamp:(s.timestamp+s.offset)*1e3,data:s.data});MistUtil.event.send("progress",null,i)}catch(t){if(r.debugging)console.error("Error while decoding track "+s.track+" ("+o.track.codec+" "+o.track.type+")",s,t);e.log(t+" while decoding track "+s.track+" ("+o.track.codec+" "+o.track.type+")");o.reset()}n.jitter.addChunk(s)};this.pipelines={};function c(){var e=this;function t(){var e=this;var t={};function r(){var e=this;this.writer=undefined;this.decoder=undefined;this.addWriter=function(e){this.writer=e.getWriter()};this.writeFrame=function(t){try{return e.writer.write(t)}catch(e){return new Promise((function(t,r){r(e)}))}}}this.onmessage=function(i){var n=i.data;n.status="ok";if("idx"in n&&!(n.idx in t))t[n.idx]=new r;var a=t[n.idx];switch(n.type){case"writeFrame":{a.writeFrame(n.frame).then((function(){delete n.frame;e.postMessage(n)})).catch((function(t){n.status="error";n.error=t;n.frame.close();delete n.frame;e.postMessage(n)}));return}case"setWritable":{a.addWriter(n.writable);delete n.writable;break}case"close":{delete t[n.idx];break}}this.postMessage(n)}}this.worker=new Worker(URL.createObjectURL(new Blob(["("+t.toString()+")();"],{type:"application/javascript"})));this.worker.onmessage=function(t){var r=t.data;var i=[r.type,r.idx,r.uid].join("_");if(i in e.listeners){e.listeners[i](r);delete e.listeners[i]}else{console.warn("Received msg from worker",r)}};this.listeners={};var r=0;this.addListener=function(e,t){var r=[e.type,e.idx,e.uid].join("_");if(t){this.listeners[r]=t}var i=this;return new Promise((function(e,t){i.listeners[r]=function(r){if(r.status=="error")return t(r);e(r)}}))};this.post=function(t,i){if(!("uid"in t)){t.uid=r++}if(i&&i.transfer&&!Array.isArray(i.transfer)){i.transfer=[i.transfer]}this.worker.postMessage(t,i);return new Promise((function(r,i){e.addListener(t).then(r).catch(i)}))};this.terminate=function(){this.worker.terminate()}}this.worker=new c;function u(t){if(!(typeof t=="object")){t=s(t)}if(t.type!="audio"&&t.type!="video"){n.control.send({type:"hold"});return}var a=this;a.track=t;a.codec=t.codecstring||(""+t.codec).toLowerCase();a.lastReset=null;a.closeWhenEmpty=false;e.log("Creating pipeline for track "+t.idx+" ("+t.codec+" "+t.type+")");a.createTrack=function(){if(a.trackGenerator){n.stream.removeTrack(a.trackGenerator)}a.trackGenerator=new MediaStreamTrackGenerator({kind:t.type});n.worker.post({idx:t.idx,type:"setWritable",writable:a.trackGenerator.writable},{transfer:a.trackGenerator.writable});a.trackWriter=new function e(){this.write=function(e){a.stats.timing.writable.start(e.timestamp);return n.worker.post({idx:t.idx,type:"writeFrame",frame:e},{transfer:e}).finally((function(){a.stats.timing.writable.end(e.timestamp)}))}}};a.createTrack();var o={tid:false,targetTime:false};a.waitingTimer=false;var c=0;function f(e){if(n.frameTiming.paused)return;if(!a.queues.out.length){if(a.closeWhenEmpty){a.close(true)}else{var s=performance.now()-n.frameTiming.out.timestamp*.001/n.frameTiming.speed.combined;var c=s-n.frameTiming.out.baseTime;if(isNaN(c)||c>1e3||c<50){c=50}if(r.debugging){console.log("Uhoh: output queue for "+function(e){switch(e){case"video":return"üéûÔ∏è";case"audio":return"üéµ";default:return e}}(t.type)+" track",t.idx,"is empty!","Increased playback timer with",Math.round(c),"ms")}n.frameTiming.out.baseTime=s;if(!a.waitingTimer){a.waitingTimer=setTimeout((function(){MistUtil.event.send("waiting",null,i)}),1e3)}}return}if(o.tid){if(r.debugging&&(new Date).getTime()-o.targetTime>1e3){console.log("‚ö†Ô∏è",function(e){switch(e){case"video":return"üéûÔ∏è";case"audio":return"üéµ";default:return e}}(t.type),"processQueue() outputTimer already active:","ending at",new Date(o.targetTime).toLocaleTimeString(),"seeking to",n.frameTiming.seeking?MistUtil.format.time(n.frameTiming.seeking*1e-6):"no","first timestamp",MistUtil.format.time(a.queues.out[0].timestamp*1e-6))}return}if(a.waitingTimer){clearTimeout(a.waitingTimer);a.waitingTimer=false}var u=a.queues.out[0];if(a.queues.out.length>1&&a.queues.out[1].timestamp<u.timestamp){if(r.debugging){console.warn("‚ö†Ô∏è",function(e){switch(e){case"video":return"üéûÔ∏è";case"audio":return"üéµ";default:return e}}(t.type),"Frames out of order!","diff:",(a.queues.out[1].timestamp-u.timestamp)*.001,"ms","this frame:",u,"next frame:",a.queues.out[1])}var d=a.queues.out.splice(1,1)[0];a.queues.out.unshift(d);return f(e)}var m=n.frameTiming.get("out");if(m){var p=0;var g=m.baseTime+u.timestamp*.001/n.frameTiming.speed.combined-p;if(isNaN(g))throw"Invalid target time: "+g;var h=g-performance.now();if(!e)a.stats.early=h;else{if(r.debugging&&Math.abs(h)>10){console.log("‚ö†Ô∏è",function(e){switch(e){case"video":return"üéûÔ∏è";case"audio":return"üéµ";default:return e}}(t.type),"processQueue() timer end reached, but off by more than 10ms; delay:",Math.round(h*100)/100,"ms","original delay:",Math.round(e),"ms")}}if(h<=2){return l()}else{o.tid=setTimeout((function(){o.tid=false;o.targetTime=false;f(h)}),h);o.targetTime=(new Date).getTime()+h;if(h>1e3){console.warn("‚ö†Ô∏è",function(e){switch(e){case"video":return"üéûÔ∏è";case"audio":return"üéµ";default:return e}}(t.type),"processQueue() delay high:",Math.round(h),"ms","ending at",new Date(o.targetTime).toLocaleTimeString(),"seeking to",n.frameTiming.seeking?MistUtil.format.time(n.frameTiming.seeking*1e-6):"no","first timestamp",MistUtil.format.time(a.queues.out[0].timestamp*1e-6))}if(e&&r.debugging){console.warn("‚ö†Ô∏è",function(e){switch(e){case"video":return"üéûÔ∏è";case"audio":return"üéµ";default:return e}}(t.type),"processQueue() timer re-timered, delay was ",e,", needs another ",h,"ms")}}}else{n.frameTiming.set("out",{baseTime:performance.now()-u.timestamp*.001/n.frameTiming.speed.combined});return l()}}function l(){var e=a.queues.out.shift();if(n.frameTiming.seeking){if(e.timestamp<n.frameTiming.seeking){e.close();if(r.debugging=="verbose"){console.log("‚ÄºÔ∏è",function(e){switch(e){case"video":return"üéûÔ∏è";case"audio":return"üéµ";default:return e}}(t.type),"Skipped display of "+t.type+" frame because it is before the seek time",e.timestamp,"<",n.frameTiming.seeking)}return}else{if(r.debugging)console.warn("Reached seek target of ["+MistUtil.format.time(n.frameTiming.seeking*1e-6)+"]: returning to normal playback");n.frameTiming.seeking=undefined;MistUtil.event.send("seeked",null,i);n.jitter.reset()}}a.stats.frames.out++;var s=a.trackWriter.write(e).then((function(){n.frameTiming.set("out",{timestamp:e.timestamp,processed:(new Date).getTime()})})).catch((function(){console.warn("Trackwriter.write failed for",e);e.close()}));MistUtil.event.send("timeupdate",null,i);setTimeout(f,0)}var d={output:function(e){a.stats.timing.decoder.end(e.timestamp);if(v){e.close();return}a.queues.out.push(e);if(r.debugging=="verbose")console.log("New frame exited "+t.type+" decoder:",e);setTimeout((function(){n.frameTiming.set("decoded",{timestamp:e.timestamp,decoded:(new Date).getTime()});f()}),0)},error:function(i){if(r.debugging)console.error("Decoder error:",i,"Config:",m);e.log(MistUtil.format.ucFirst(t.type)+" decoder error: "+i+" (Track "+t.idx+")");a.reset()}};var m={codec:a.codec,optimizeForLatency:e.info.type=="live"};var p=false;a.configure=function(i){if(a.decoder.state!="unconfigured"){if(function e(t,r){return t===r||indexedDB.cmp(t,r)===0}(i,m.description)){e.log("Received equal init data for track "+t.idx+" ("+t.codec+" "+t.type+") that was already configured: not resetting");return}e.log("Received new init data for track "+t.idx+" ("+t.codec+" "+t.type+") that was already configured: resetting");a.decoder.reset()}if(r.debugging)console.log("Configuring decoder for track",t.idx,"("+t.codec+" "+t.type+")",m,i?"Header size:":"(No header)",i?i.byteLength+"B":"");n.stream.addTrack(a.trackGenerator);a.decoder.configure(Object.assign(m,{description:i}));p=true;if(r.debugging)console.log("Configure track "+t.idx+" complete")};a.decoder;a.decode;switch(t.type){case"video":{if(t.codec=="JPEG"){a.decode=function(e){return new Promise((function(){var t=new ImageDecoder({type:"image/jpeg",data:e.data});a.stats.timing.decoder.start(e.timestamp);t.decode().then((function(t){if(t.complete){var r=new VideoFrame(t.image,{timestamp:e.timestamp});d.output(r)}}))}))};a.configure=function(){n.stream.addTrack(a.trackGenerator);a.decoder.state="configured"};a.decoder={state:"unconfigured",close:function(){}}}else{a.decoder=new VideoDecoder(d);a.decode=function(e){if(p){if(e.type=="key"){if(r.debugging){console.log("Got a "+function(e){switch(e){case"video":return"üéûÔ∏è";case"audio":return"üéµ";default:return e}}(t.type)+" key!",e)}p=false}else{if(r.debugging)console.log("Skipped "+function(e){switch(e){case"video":return"üéûÔ∏è";case"audio":return"üéµ";default:return e}}(t.type)+" frame because waiting for a key",e);return}}a.stats.timing.decoder.start(e.timestamp);return a.decoder.decode(new EncodedVideoChunk(e))}}break}case"audio":{a.decoder=new AudioDecoder(d);m.numberOfChannels=t.channels;m.sampleRate=t.rate;a.decode=function(e){e.type="key";a.stats.timing.decoder.start(e.timestamp);return a.decoder.decode(new EncodedAudioChunk(e))};break}}a.reset=function(){if(y)return y;y=new Promise((function(i,s){if(r.debugging)console.log("Resetting track "+t.idx+" ("+t.codec+" "+t.type+")");if(a.decoder.state=="closed"){if(a.lastReset===null||(new Date).getTime()-a.lastReset.getTime()>1e3){if(r.debugging)console.warn("Recreating pipeline");n.stream.removeTrack(a.trackGenerator);if(a.decoder.decodeQueueSize)a.decoder.flush();var o=a;a=new u(t);a.closeWhenEmpty=this.closeWhenEmpty;a.lastReset=new Date;a.configure(m.description);a.queues.out=o.queues.out;i()}else{e.timers.start((function(){a.reset().then(i)}),1e3)}}else{a.lastReset=new Date;if(v){v.finally((function(){a.createTrack();a.decoder.reset();a.configure(m.description);i()}))}else{a.createTrack();a.decoder.reset();a.configure(m.description);i()}}}));y.then((function(){y=false}));return y};a.empty=function(){return new Promise((function(e,i){a.queues.in=[];if(o.tid){clearTimeout(o.tid);o.tid=false}if(r.debugging){console.log("Clearing input queue for "+function(e){switch(e){case"video":return"üéûÔ∏è";case"audio":return"üéµ";default:return e}}(t.type)+" pipeline")}if(v)return v;if(a.decoder.state=="closed"){var n=a.queues.out;a.queues.out=[];while(n.length){var s=n.shift();if(s)s.close()}e()}else{v=a.decoder.flush().catch((function(e){if(r.debugging){console.error("‚ÄºÔ∏è",function(e){switch(e){case"video":return"üéûÔ∏è";case"audio":return"üéµ";default:return e}}(t.type),"Error while flushing:",e)}})).finally((function(){var t=a.queues.out;a.queues.out=[];v=false;while(t.length){var r=t.shift();if(r)r.close()}e()}))}}))};if(t.init==""){a.configure()}a.queues={in:[],out:[]};a.stats={frames:{in:0,out:0},early:0,framerate:{in:new g((function(){return a.stats.frames.in})),out:new g((function(){return a.stats.frames.out}))},timing:{decoder:new h,writable:new h}};function g(e){var t,r;this.get=function(){var i=e();var n=performance.now();var a;if(typeof t!="undefined"){var s=i-t;var o=n-r;o*=.001;a=s/o}t=i;r=n;return a}}function h(){var e={};var t=[];this.last_in=undefined;this.last_out=undefined;this.shift_array=[];this.start=function(t){this.last_in=t;e[t]=performance.now()};this.end=function(r){this.last_out=r;var i=0;if(!(r in e)){r=function(e){for(var t in e)return t;return undefined}(e);if(r===undefined)return;i=r-this.last_out}t.push(performance.now()-e[r]);this.shift_array.push(i);delete e[r];while(t.length>16){t.shift()}while(this.shift_array.length>8){this.shift_array.shift()}};Object.defineProperty(this,"delay",{get:function(){if(t.length){return t.reduce((function(e,t){return e+t}))/t.length}return undefined}});Object.defineProperty(this,"delta",{get:function(){if(this.last_out!==undefined)return this.last_in-this.last_out;return undefined}});Object.defineProperty(this,"shift",{get:function(){if(this.shift_array.length){return this.shift_array.reduce((function(e,t){return e+t}))/this.shift_array.length}return undefined}})}var w=false;var v=false;var y=false;a.receive=function(e){if(y||v){a.queues.in.push(e);if(r.debugging=="verbose"){console.log("Queued",function(e){switch(e){case"video":return"üéûÔ∏è";case"audio":return"üéµ";default:return e}}(t.type),"frame because "+(y?"resetting":"flushing"),"Queue length:",a.queues.in.length,e)}return}r.controller.frameTiming.set("in",{timestamp:e.timestamp,received:(new Date).getTime()});a.stats.frames.in++;switch(a.decoder.state){case"configured":{a.queues.in.push(e);if(!w){w=true;var i=false;if(i){while(a.queues.in.length>=2){var n=a.queues.in.shift();var s=a.queues.in[0];a.decode(n)}}else{while(a.queues.in.length){var n=a.queues.in.shift();a.decode(n)}}w=false}return}case"closed":{return}case"unconfigured":{a.queues.in.push(e);return}default:{console.log("Decoder state for ",codec,"is",a.decoder.state);return}}};var k=false;a.close=function(r){if(!k)k=Promise.withResolvers();function i(){if(a.queues.out.length)return false;if(a.queues.in.length)return false;if(a.decoder.decodeQueueSize)return false;return true}if(r&&!i()){if(!a.closeWhenEmpty){a.closeWhenEmpty=true;e.log("The pipeline for track "+t.idx+" will close once empty")}}else{n.stream.removeTrack(a.trackGenerator);n.worker.post({type:"close",idx:t.idx});a.decoder.close();a.empty();delete n.pipelines[t.idx];e.log("The pipeline for track "+t.idx+" has now been closed");k.resolve()}return k.promise};n.pipelines[t.idx]=a}function f(){this.set=function(e,t){var r=this[e];if(!r){this[e]={};r=this[e]}r=Object.assign(r,t);return r};this.tweakSpeed=function(e){this.setSpeed(this.speed.main,e)};this.setSpeed=function(t,r){if(!r)r=this.speed.tweak;if(t==this.speed.main&&r==this.speed.tweak)return;var i=t*r;var a=this.get("out");if(a.baseTime&&a.timestamp){this.set("out",{baseTime:a.baseTime+a.timestamp*.001/this.speed.combined-a.timestamp*.001/i})}e.video.playbackRate=i;for(var s in n.pipelines){var o=n.pipelines[s];if(o.track.type=="audio"){o.reset()}}if(this.speed.main!=t)MistUtil.event.send("ratechange",null,e.video);this.speed.main=t;this.speed.tweak=r;this.speed.combined=i};this.get=function(e){return this[e]};this.reset=function(){this.in=false;this.decoded=false;this.out=false;this.paused=false;this.speed={main:1,tweak:1,combined:1}};this.reset()}this.frameTiming=new f;var l=e.info.type=="live"?100:500;this.desiredBuffer=function(){return Math.round(l+n.control.serverDelay.get()+n.jitter.get())};this.connect=function(){if(this.connecting){return this.connecting}this.connecting=new Promise((function(t,a){var s=n.control;if(s.connectionState=="closing"||s.connectionState=="closed"){s.reconnect()}n.stream=new MediaStream;n.stream.onaddtrack=function(e){if(r.debugging)console.log("MediaStream received new track",e)};i.srcObject=n.stream;n.frameTiming.reset();return n.control.addListener("channel_open").then((function(){var t=[Object.values(d).filter((function(e){return e.length}))];s.send({type:"request_codec_data",supported_combinations:t});e.log("Requesting codecs: "+t.join(", "));n.connecting=false;return s.addListener("codec_data")})).then((function(a){if(!a.codecs||!a.codecs.length){throw"No playable codecs available"}for(var o in a.tracks){var c=a.tracks[o];if(!(o in a.codecs))throw"No codec data for track "+c;n.pipelines[c]=new u(c)}s.send({type:"play"});s.addListener("binary",n.receiver);var f=false;s.addListener("on_time",(function(t){for(var i in t.tracks){var a=t.tracks[i];if(!(a in n.pipelines)){if(r.debugging)console.warn("Received on_time with track "+a+" but there is no pipeline for it, attempting to create it");var o=new u(a)}}for(var a in n.pipelines){if(t.tracks.indexOf(Number(a))<0){n.pipelines[a].close(true)}}var c=n.frameTiming.get("server");if(c&&t.current!=c.current){for(var a in n.pipelines){var d=n.pipelines[a];if(d.waitingTimer){clearTimeout(d.waitingTimer);d.waitingTimer=false}}}var m={low:.6,high:2};var p={faster:1.05,slower:.98};var g=null;var h=n.frameTiming.get("out");var w=n.frameTiming.get("in");var v=n.frameTiming.get("decoded");if(h.timestamp&&v.timestamp){g=Math.round(v.timestamp*.001-h.timestamp*.001);decodingTime=Math.round(w.timestamp*.001-v.timestamp*.001)}if(g!==null&&!n.frameTiming.seeking&&!f){var y=n.desiredBuffer();if(r.debugging){var k=["Buffer:",function(){if(g>y*m.high){return"‚¨ÜÔ∏è"}if(g<y*m.low){return"‚¨áÔ∏è"}return"üü¢"}(),g,"/",y,{keepAway:l,serverDelay:Math.round(n.control.serverDelay.get()),jitter:Math.round(n.jitter.get())},"Decoding time:",Math.round(Math.max.apply(null,Object.values(r.api.decodeTime))),"Decoding queues:",Math.max.apply(null,Object.values(r.api.decodeQueue)),"Earliness:",Math.round(Math.min.apply(null,Object.values(r.api.earliness))),"Available:",t.end-t.current,"Tweak:",function(e){if(e>1){return"‚ÜóÔ∏è"}if(e<1){return"‚ÜòÔ∏è"}return"üü¢"}(n.frameTiming.speed.tweak),n.frameTiming.speed.tweak];if(e.info.type=="live"){k.unshift("From live:",Math.round(t.end*.01-h.timestamp*1e-5)/10,"s")}console.log.apply(null,k)}if(g<y*m.low&&t.play_rate_curr!="fast-forward"&&n.frameTiming.speed.tweak>=1){var b=0;if(g<10){var T=r.api.earliness;if(T)b=-1*Math.min.apply(null,Object.values(T));b=Math.max(0,b)}if(t.current<t.end){f=true;s.send({type:"fast_forward",ff_add:y+b});if(n.frameTiming.speed.tweak>1){n.frameTiming.tweakSpeed(1)}e.log("Our buffer ("+g+"ms) is small (<"+Math.round(y*m.low)+"ms), requesting more data (+"+Math.round(y+b)+"ms)..");var M=false;s.addListener("set_speed").then((function(i){M=true;if(i.play_rate_prev=="fast-forward"){s.addListener("on_time").then((function(i){var a=0;var s=n.frameTiming.get("out");var o=n.frameTiming.get("in");if(s.timestamp&&o.timestamp){a=Math.round(o.timestamp*.001-s.timestamp*.001)}var c=i.current-t.current-(i._received-t._received);if(r.debugging)console.warn("Extra buffer received:",i.current-t.current,"ms","Time taken:",i._received-t._received,"ms","Increase:",c,"ms");if(g+c<y*m.low){n.frameTiming.tweakSpeed(p.slower);l+=100;e.log("Didn't receive enough extra data to increase our buffer ("+c+"/"+Math.round(y*m.low-g)+"ms): slowing down..")}else{e.log("Received +"+c+"ms extra data")}f=false}))}else{f=false}}));s.addListener("on_time").then((function(t){if(M)return;if(f&&t.play_rate_curr!="fast-forward"){f=false;n.frameTiming.tweakSpeed(p.slower);l+=100;e.log("Didn't receive extra data: slowing down..")}}))}else{if(n.frameTiming.speed.main>1){s.send({type:"set_speed",play_rate:"auto"})}n.frameTiming.tweakSpeed(p.slower);e.log("Our buffer ("+g+"ms) is small (<"+Math.round(y*m.low)+"ms), but can't request more data: slowing down..")}}else{if(n.frameTiming.speed.tweak<1&&g>=y){n.frameTiming.tweakSpeed(1);e.log("Our buffer ("+g+"ms) is large enough (>"+Math.round(y)+"ms), so return to normal playback.")}else{if(e.info.type=="live"&&e.options.liveCatchup){if(t.play_rate_curr=="auto"&&n.frameTiming){if(n.frameTiming.speed.tweak<=1&&g>y*m.high){n.frameTiming.tweakSpeed(p.faster);e.log("Our buffer ("+g+"ms) is big (>"+Math.round(y*m.high)+"ms), so tweak the playback speed to catch up.")}else if(n.frameTiming.speed.tweak>1&&g<=y){n.frameTiming.tweakSpeed(1);e.log("Our buffer ("+g+"ms) is small enough (<"+Math.round(y)+"ms), so return to normal playback.")}}if(t.play_rate_curr!="fast-forward"){var _=t.end-t.current;if(_<e.options.liveCatchup*1e3&&_>Math.max(t.jitter*1.1,t.jitter+250)&&g-y<1e3){s.send({type:"fast_forward",ff_add:5e3});e.log("We're away ("+_+"ms) from the live point, requesting more data..")}}}}}}n.frameTiming.set("server",t)}));n.control.addListener("set_speed",(function(e){var t;switch(e.play_rate_curr){case"auto":case"fast-forward":{t=1;break}default:{t=e.play_rate_curr;break}}n.frameTiming.setSpeed(t);n.jitter.setSpeed(e.play_rate_curr)}));s.addSendListener("seek",(function(e){var t=e.seek_time;MistUtil.event.send("seeking",t*.001,i);n.jitter.reset();if(r.debugging)console.warn("Seeking to ["+MistUtil.format.time(t*.001)+"]: Emptying decoding and display queues");for(var a in n.pipelines){n.pipelines[a].empty();n.pipelines[a].reset()}n.frameTiming.seeking=t*1e3;n.frameTiming.set("out",{baseTime:performance.now()-t/r.controller.frameTiming.speed.combined,timestamp:t*1e3});if(r.debugging)console.log("Frame timing was set to seek mode",{seeking:n.frameTiming.seeking,out:n.frameTiming.out});MistUtil.event.send("timeupdate",t*.001,i)}));s.addListener("pause",(function(e){if(e.paused)n.frameTiming.paused=true}));s.addSendListener("play",(function(){n.frameTiming.reset()}));t()})).catch((function(t){e.showError(t);if(r.debugging){console.error(t)}}))}));return this.connecting};this.close=function(){this.control.removeListener("binary",n.receiver);this.control.close();this.worker.terminate();if(n.stream){for(var e in n.pipelines){n.pipelines[e].close()}}};var d={audio:[],video:[]};function m(){var t=[],r=mistplayers.rawws;if(!(e.stream in r.cacheSupported)){r.cacheSupported[e.stream]={}}var i=r.cacheSupported[e.stream];function n(r){function n(e,t){if(e.indexOf(t)<0)e.push(t)}var a=e.info.meta.tracks[r];if(a.type!="audio"&&a.type!="video"){return}if(r in i){if(i[r]){n(d[a.type],a.codec)}}else{t.push(mistplayers.rawws.isTrackSupported(a).then((function(e){i[r]=e.supported;if(e.supported){n(d[a.type],a.codec)}})))}}for(var a in e.info.meta.tracks){n(a)}if(t.length){Promise.all(t).then(p).catch(console.err)}else{p()}}function p(){var t=false;if(t){d={audio:[],video:[]};for(var r in e.info.meta.tracks){var i=e.info.meta.tracks[r];switch(i.type){case"audio":case"video":{if(d[i.type].indexOf(i.codec)<0)d[i.type].push(i.codec)}}}}else{var a=mistplayers.rawws.cacheSupported[e.stream].last;var s=e.scoreCombo(mistplayers.rawws.isBrowserSupported(e.source.type,e.source,e));if(s<1){e.log("After testing decoders, "+mistplayers[e.playerName].name+" cannot play any tracks after all: trying next combo..");e.nextCombo(false,"rawws cannot play any tracks");return}var o=mistplayers.rawws.cacheSupported[e.stream].last;for(var c in a){if(!(c in o)){var u=e.checkCombo({startCombo:false},true);if(u.score>s&&u.player!=e.playerName){e.log("After testing decoders, "+mistplayers[e.playerName].name+" is no longer the best scoring player, trying next combo..");e.nextCombo(false,"after testing, rawws is no longer the best player");return}break}}e.log("Confirmed "+mistplayers[e.playerName].name+" is still the best scoring player, connecting..")}n.connect()}m()}this.controller=new s(e.source.url);var o={};o.currentTime={get:function(){var e=r.controller.frameTiming;if(e){var t=e.get("out").timestamp;return t?t*1e-6:0}else return 0},set:function(e){r.controller.control.send({type:"seek",seek_time:e=="live"?"live":Math.round(e*1e3),ff_add:r.controller.desiredBuffer()})}};o.buffered={get:function(){return new function e(){var t=r.controller.frameTiming;Object.defineProperty(this,"length",{get:function(){if(t&&t.get("in")&&t.get("out"))return 2;return 0}});this.start=function(e){if(t){var r;switch(e){case 0:r=t.get("out");break;case 1:r=t.get("decoded");break;default:throw new Error("Index out of bounds")}return r&&"timestamp"in r?r.timestamp*1e-6:0}};this.end=function(e){if(t){var r;switch(e){case 0:r=t.get("decoded");break;case 1:r=t.get("in");break;default:throw new Error("Index out of bounds")}return r&&"timestamp"in r?r.timestamp*1e-6:0}}}}};o.duration={get:function(){var t=r.controller.frameTiming;if(t){var i=t.get("server");if(i&&"end"in i){if(e.info&&e.info.type=="live"){return(i.end+(new Date).getTime()-i._received.getTime())*.001}else return i.end*.001}}return 0}};o.stream_end=function(){var e=[];for(var t in r.controller.pipelines){e.push(r.controller.pipelines[t].close(true))}Promise.all(e).then((function(){MistUtil.event.send("ended",null,i)}))};var c=false;o.restart=function(){if(c)return;c=true;var t=[];for(var i in r.controller.pipelines){t.push(r.controller.pipelines[i].close(true))}Promise.all(t).then((function(){e.log("Looping..");var t=r.controller.close();if(t instanceof Promise){t.then((function(){r.controller.connect().then((function(){c=false}))}))}else{r.controller.connect().then((function(){c=false}))}}))};o.receiveQueue={get:function(){var e={};for(var t in r.controller.pipelines){var i=r.controller.pipelines[t];if(i.track){e[i.track.type]=i.queues.in.length}}return e}};o.decodeQueue={get:function(){var e={};for(var t in r.controller.pipelines){var i=r.controller.pipelines[t];if(i.track){e[i.track.type]=i.decoder.decodeQueueSize}}return e}};o.displayQueue={get:function(){var e={};for(var t in r.controller.pipelines){var i=r.controller.pipelines[t];if(i.track){e[i.track.type]=i.queues.out.length}}return e}};o.displayBuffer={get:function(){var e={};for(var t in r.controller.pipelines){var i=r.controller.pipelines[t];if(i.track){if(i.queues.out.length){var n=i.queues.out[0];var a=i.queues.out[i.queues.out.length-1];e[i.track.type]=(a.timestamp-n.timestamp)*.001}else{e[i.track.type]=0}}}return e}};o.earliness={get:function(){var e={};for(var t in r.controller.pipelines){var i=r.controller.pipelines[t];if(i.track){if("early"in i.stats){e[i.track.type]=i.stats.early}else{e[i.track.type]=0}}}return e}};o.sync={get:function(){var e;var t;for(var i in r.controller.pipelines){var n=r.controller.pipelines[i];if(n.track){if(n.closeWhenEmpty)continue;switch(n.track.type){case"audio":{e=n;break}case"video":{t=n;break}}}}function a(e){if(e.queues.out.length)return e.queues.out[0].timestamp;throw 1}try{return Math.abs(a(e)-a(t))*.001}catch{return 0}}};o.framerate_in={get:function(){return function(){var e={};for(var t in r.controller.pipelines){var i=r.controller.pipelines[t];if(i.track){if("in"in i.stats.framerate){e[i.track.type]=i.stats.framerate.in.get()}else{e[i.track.type]=0}}}return e}}};o.framerate_out={get:function(){return function(){var e={};for(var t in r.controller.pipelines){var i=r.controller.pipelines[t];if(i.track){if("out"in i.stats.framerate){e[i.track.type]=i.stats.framerate.out.get()}else{e[i.track.type]=0}}}return e}}};o.local_jitter={get:function(){return r.controller.jitter.get()}};o.decodeTime={get:function(){var e={};for(var t in r.controller.pipelines){var i=r.controller.pipelines[t];if(i.track){if(i.stats.timing.decoder){e[i.track.type]=i.stats.timing.decoder.delay}else{e[i.track.type]=0}}}return e}};o.displayTime={get:function(){var e={};for(var t in r.controller.pipelines){var i=r.controller.pipelines[t];if(i.track){if(i.stats.timing.writable){e[i.track.type]=i.stats.timing.writable.delay}else{e[i.track.type]=0}}}return e}};o.shift={get:function(){var e={};for(var t in r.controller.pipelines){var i=r.controller.pipelines[t];if(i.track){if(i.stats.timing.decoder){e[i.track.type]=i.stats.timing.decoder.shift}else{e[i.track.type]=0}}}return e}};this.api=new MistUtil.shared.ControlChannelAPI(r.controller,e,i,o);this.api.unload=function(){r.controller.close()};t(i)};